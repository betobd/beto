//$debug if=
var out = new ilex.meibo.server.script.ScriptletStringBuffer(); out.append("<?xml version=\"1.0\" encoding=\"iso-8859-1\"?>\n")
  .append("<!DOCTYPE document !DOCTYPE document \n")
  .append("  PUBLIC \"-//UJAC.org//Print Document //EN\"\n")
  .append("  \"http://ujac.sourceforge.net/ujac-print-document.dtd\"> \n")
  .append("<html xmlns=\"http://www.w3.org/1999/xhtml\" xml:lang=\"fr\" lang=\"fr\">\n")
  .append("<head>\n")
  .append("     \n")
  .append("</head>\n")
  .append("<document size=\"A4\" margin-left=\"25\" margin-right=\"25\" margin-top=\"25\" margin-bottom=\"25\" logical-pagestyle=\"0\" logical-pagetext=\"Page\">\n")
  .append("<div class=tableauTrombinoscope>\n")
  .append("  ");
  var parameters = getProvisioningParameters_General();
  var BCOM_TROMBINOSCOPE_NB_RESULTAT_PAR_PAGE = returnEmpty(parameters.get("BCOM_TROMBINOSCOPE_NB_RESULTAT_PAR_PAGE"));
  var nbCol = parseInt(parameters.get("BCOM_TROMBINOSCOPE_NB_COLONNE"));
  if ( BCOM_TROMBINOSCOPE_NB_RESULTAT_PAR_PAGE != "" ){
    meibo.setFieldValue("pageSize",BCOM_TROMBINOSCOPE_NB_RESULTAT_PAR_PAGE);
  }



  var RECHERCHE_FILTER_TROMBINOSCOPE = meibo.getGlobalVar("RECHERCHE_FILTER_TROMBINOSCOPE");
  meibo.setFieldValue("filter",RECHERCHE_FILTER_TROMBINOSCOPE);

  var resultset = meibo.executeResource("People",RECHERCHE_FILTER_TROMBINOSCOPE,0);
  var nEntries = resultset.getEntryCount();
  if ( resultset.getEntryCount() > 0 ){
    // launch the search and display results on the same page
    var /*int*/ pageSize = parseInt(meibo.getFieldValue("pageSize"));
    var /*int*/ pages = ((nEntries - 1) / pageSize) + 1;
    var /*int*/ page = parseInt(meibo.getFieldValue("page"));
    meibo.setFieldValue("pages", "" + pages);
    var /*int*/ start = (page - 1) * pageSize;
    var /*String*/ filter = meibo.getFieldValue("filter");
    var resultat = meibo.executeResource("People",filter,0);
    resultat.sort("sn,givenName",true,false);
    var nEntries = resultat.getEntryCount();
    if (nEntries == 0) {
      //meibo.showField("error", true);
      meibo.showField("searchContainer",false);
    }
    else {
      // show-hide button
      meibo.showField("searchContainer",true);
      meibo.showField("next", page < pages);
      meibo.showField("last", page < pages);
      meibo.showField("previous", page > 1);
      meibo.showField("first", page > 1);
      meibo.setFieldValue("range", "Page " + page+ "/" + pages);
      
      var nbligne = ( (parseInt(parameters.get("BCOM_TROMBINOSCOPE_NB_RESULTAT_PAR_PAGE")) - 1 ) / nbCol ) + 1;   

      var BCOM_TROMBINOSCOPE_NB_RESULTAT_PAR_PAGE = parseInt(parameters.get("BCOM_TROMBINOSCOPE_NB_RESULTAT_PAR_PAGE"))
      var testNbResPage = page * BCOM_TROMBINOSCOPE_NB_RESULTAT_PAR_PAGE;
      var nbResPage = 0;
      if ( testNbResPage < nEntries ){
        nbResPage = BCOM_TROMBINOSCOPE_NB_RESULTAT_PAR_PAGE;
      }
      else{
        nbResPage = nEntries - ( ( page - 1 ) * BCOM_TROMBINOSCOPE_NB_RESULTAT_PAR_PAGE );
      }

      var j = 1; //-- incrément ligne
      var incRes = BCOM_TROMBINOSCOPE_NB_RESULTAT_PAR_PAGE * ( page - 1 ) ; //-- incrément du résultset
      var incPage = 1; //-- incrément sur le page
      while ( j < nbligne + 1 ){ //-- boucle sur les lignes
        var i = 1; //-- incrément colonne
        out.append("\n")
  .append("        <div class=lignesTrombinoscope>\n")
  .append("        ");
        while ( i < nbCol + 1 ){//-- boucle sur les colonnes
          
          var photo = returnEmpty(resultat.getEntry(incRes).getAttributeValue("jpegPhoto"));
          var sn = returnEmpty(resultat.getEntry(incRes).getAttributeValue("sn"));
          var givenName = returnEmpty(resultat.getEntry(incRes).getAttributeValue("givenName"));
          var dn = returnEmpty(resultat.getEntry(incRes).getAttributeValue("dn"));
          
          var displayName = miseEnForme(givenName) + " " + sn.toUpperCase();
          out.append("\n")
  .append("          <div class=fondTrombinoscope><div class=photoTrombinoscope><img src=></img></div><div class=nomTrombinoscope>");out.append(scripter.HTMLEncode(scripter.toString(displayName)));out.append("</div></div>     \n")
  .append("          <div class=fondVideTrombinoscope>\n")
  .append("          </div>\n")
  .append("          ");
          
          //meibo.getField("results").addCellObject(j-1,i-1,dn);
          if ( incPage == nbResPage ){ //-- SI NOMBRE DE RESULTAT AFFICHE ATTEINT
            break; //-- STOPPE AFFICHAGE
          }
          else{
           incPage++;//-- incrémentation des resultat sur une page
          }
          incRes++;//-- incrémentation du résultset
          i++;//-- incrémentation colonne
        }
        out.append("\n")
  .append("        </div>\n")
  .append("        <div class=lignesVidesTrombinoscope>\n")
  .append("        </div>\n")
  .append("        ");
        if ( incPage == nbResPage ){ //-- SI NOMBRE DE RESULTAT AFFICHE ATTEINT
            break; //-- STOPPE AFFICHAGE
        } //-- FIN boucle sur les colonnes  
        j++;//-- incrémentation ligne
      }//-- FIN boucle sur les ligne 
    }
  }

  out.append("\n")
  .append("</div>  \n")
  .append("</document>");meibo.setReturnObject(out.toString());
